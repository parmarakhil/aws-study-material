# ELB & ASG

1. loadbalancer
    1. Load balancers are servers that forward internet traffic to multiple servers downstream
    2. Used to spread load across downstream instances
    3. Expose a single point of access eg DNS to your application
    4. Seamlessly. Handle failures of downstream instances
    5. Do regular health checks of instances
    6. Provide SSL termination
    7. Enforce stickiness with cookies
    8. High availability across AZ
    9. Separate public traffic from private traffic
2. ELB
    1. ELB is a managed load balancer
    2. AWS take care of upgrades, maintenance
    3. AWS provides few configuration knobs
    4. Health checks help load balancer to understand if instance is healthy and send traffic to healthy servers
    5. If instance is not healthy then traffic is not sent to that instance
    6. Health checks Happen every 5 seconds
        1. If health checks are not configured properly or Security group is not accepting traffic then health check will fail
    7. Types
        1. Classic load balancer (v1)
            1. Supports HTTP, HTTPS, TCP traffic I.e layer 4 & layer 7 traffic
            2. Health checks are TCP or HTTP based
            3. You get fixed hostname
        2. Application load balancer (ALB) (v2)
            1. Supports HTTP, HTTPS,  Websocket traffic I.e layer 7 traffic
            2. Load balancing to multiple HTTP applications across machines or target groups
            3. Load balancing to multiple applications on the same machine eg containers
            4. Support for HTTP/2 and web socket
            5. Supports routing (https to http)
            6. Routing tables to different target groups
                1. Routing based on path in url eg example.com/users & example.com/admins
                2. Routing based on hostname in url eg one.example.com & two.example.com
                3. Routing based on query strings or headers eg example.com/users?id=123&post=new
                4. ALB cannot route based on geography
            7. It is great fir for micro services and container based applications
            8. Has port mapping feature to redirect to a dynamic port in ECS
            9. If it was CLB we need 1 CLB per application
            10. Target groups
                1. EC2 instances (can be managed by ASG)
                2. ECS tasks (managed by ECS itself)
                3. Lambda functions (http request is translated into a JSON element)
                4. Private IP address
                5. ALB can route to multiple target group and health check can be configured at TG level
            11. You get fixed hostname
            12. The application servers don’t see the IP of client directly, it is inserted in header “X-Forwarded-For”, for port “X-Forwarded-Port” and port (X-Forwarded-Proto)
        3. Network load balancer (NLB) (v2)
            1. Supports TCP, TLS and UDP traffic I.e layer 4 traffic
            2. Handle millions of requests per second
            3. Less latency
            4. NLB has one static IP per AZ and supports assigning elastic IP
            5. NLB are used for extreme performance, TCP or UDP traffic
            6. It redirect traffic from client directly, so the instances need to accept traffic from anywhere instead of security group
    8. You can setup internal (private) or external (public) ELB
    9. Load balancers can scale but not instantaneously, it needs warm-up
    10. 4xx are client induced errors
    11. 5xx are application induced errors
    12. 503 means at capacity or no registered target
    13. If LB can’t connect to application, check security groups
    14. ELB access logs will log all access requests
    15. Cloudwatch metrics will give aggregate statistics
    16. Sticky sessions (Sticky affinity)
        1. It is possible to implement stickiness so that the same client is always redirected to same instance behind load balancer
        2. This can also lead to uneven distribution of load
        3. Works for Classic and application load balancer
        4. Uses cookie for stickiness
        5. Cookie
            1. Application based cookie
                1. Custom cookie generated by target
                    1. Can include any custom attributes required by the application
                    2. Cookie name must be specified individually for each target group
                    3. Don’t use AWSALB, AWSALBAPP, AWSALBTG (reserve for use by the ELB)
                2. Application cookie generated by load balancer
                    1. Cookie name iis AWSALBAPP
            2. Duration based cookie
                1. Cookie generated by load balancer
                2. Cookie name is AWSALB for ALB, AWSELB for CLB
    17. Cross zone load balancing
        1. Each load balancer instance distributes evenly across all registered instances in all AZ
        2. That is if 1 AZ has 2 instance and 2nd has 8 instance, the load will be distributed across 10 instances evenly
        3. If you want to distribute load at AZ level we can disable this setting
        4. For ALB cross zone is always ON and cannot be disabled
            1. No charge for inter AZ data transfer
        5. For NLB it is disabled by default and can be enabled
            1. You pay charge for inter AZ data transfer
        6. For classic load balancer
            1. If created through console it is ENABLED by default
            2. If created through CLI/API it is DISABLED by default
            3. No charges for inter AZ data transfer
    18. SSL and TLS
        1. SSL certificates allows traffic between clients and load balancer to be encrypted in transit
        2. SSL refers to Secure socket layer
        3. TLS refers too transfer layer security
        4. User connect of HTTPS to load balancer, then it does SSL termination and then HTTP traffic is send to instances
        5. Load balancer use X.509 certificate
        6. HTTPS listener
            1. You must specify a default certificate
            2. You can add an optional list of certs to support multiple domains
            3. Clients can use SNI (Server name indication) to specify the hostname they reach
            4. Ability to specify a security policy to support older versions of SSL/TLS
    19. SNI (Server Name indication)
        1. SNI solves the problem of loading multiple SSL certificates onto one web server to serve multiple websites
        2. It is newer protocol and requires the client to indicate the hostname of target server in initial SSL handshake
        3. Only works with ALB & NLB (both supports multiple listeners with multiple SSL certificates)
        4. CLB support one SSL certificate
    20. Connection draining
        1. CLB -> connection draining
        2. Target group (ALB & NLB) -> deregistration delay
        3. Time to complete “in-flight-requests while the instance is de-registering or unhealthy
        4. Stops sending new requests to the instance which is de-registering
        5. Duration can be between 1 sec to 3600 sec, default is 300 sec
        6. Can be disabled if we set value to 0
        7. Set to a low value if your requests are short
3. Auto Scaling group (ASG)
    1. Goal
        1. Scale out when load increase
        2. Scale in when load decrease
        3. Ensure min and max number of machines running
        4. Automatically add new instances to load balancer
    2. Min —> no of instances running always
    3. Desired capacity —> actual no of instances running
    4. Max —> no of instances that can be added
    5. ASG has a launch configuration /launch templatewhich has
        1. AMI + instance type
        2. EC2 user data
        3. EBS volumes
        4. Security groups
        5. SSH key pair
        6. Network + subnet
        7. Load balancer info
        8. Scaling policies
    6. We can scale ASG based on cloud watch alarms based on metrics
    7. Metrics are computed for overall ASG instances
    8. Rules
        1. Target Average CPU usage
        2. No of requests on ELB per instance
        3. Average network in/out
        4. Custom metric eg: no of connected users (you need to send this metric to cloud watch using putMetric API)
    9. IAM role attached to ASG will be assigned to EC2 instances
    10. If a running instance gets terminated ASG will create new instance but if it is terminated in stopped state then new instances won’t be created
    11. ASG can terminated instances marked unhealthy by load balancer
    12. Scaling policies
        1. Dynamic scaling policies
            1. Target tracking scaling
                1. Most simple and easy to setup
                2. Eg: Avg ASG CPU to stay at around 50%
            2. Simple/Step scaling
                1. When a cloud watch alarm is triggered (example CPU >70%) then add 2 units
                2. When a cloud watch alarm is triggered (example CPU <30%) then remove 1 unit
            3. Scheduled actions
                1. Anticipate a scaling based on known usage patterns
                2. Eg: inc min capacity at 10-2 on Friday
        2. Predictive scaling
            1. Continuously forecast load and schedule scaling ahead
        3. Good metrics to scale
            1. CPUUtilization -> avg CPU utilisation across instances
            2. RequestCountPerTarget -> to make sure no of requests per EC2 instance is stable
            3. Avg network in/out
            4. Any custom metric
        4. Scaling cool down
            1. After a scaling activity happens you are in cool down period (default is 300 seconds)
            2. During the cool down period, the ASG will not launch or terminate additional instances ( to allow metric to stabilise)
            3. Better to use Ready to use AMI, for faster uptime and reduce cool down period
4. For solution architects
    1. ASG default termination policy
        1. Find AZ which has more no of instances
        2. If there are multiple instances in AZ to choose from, delete the one with oldest configuration
        3. ASG are region bounded
        4. ASG tries to balance no of instances across AZ
    2. Life cycle hooks
        1. By default when instance is launched it goes into Inservice state
        2. You can perform extra steps before it goes into inservice eg in pending state
        3. You can perform extra steps before it goes into terminated eg in terminating state
    3. Launch template vs launch configuration
        1. Both
            1. ID of AMI, instance type, key pair, Security groups etc are use to launch EC2 instance
        2. Launch configuration (legacy)
            1. Must be recreated every time after a change
        3. Launch template (new)
            1. Can have multiple versions
            2. Create parameters subsets (partial configuration for reuse)
            3. Provision using mix of both Ondemand and spot instances
            4. Can use T2 unlimited burst feature
            5. Recommended by AWS
	
